name: Weekly Report → Google Drive (single HTML)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 1"  # 매주 월요일 09:00 KST (UTC 00:00)

jobs:
  weekly:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install pandas google-api-python-client google-auth-httplib2 google-auth-oauthlib

      # 1) (선택) 구글 드라이브에서 일일 CSV 내려받기
      - name: Fetch daily CSVs from Google Drive
        env:
          GOOGLE_CLIENT_ID:     ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID:     ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          mkdir -p data/daily
          # 레포에 이미 있는 스크립트 사용
          python scripts/fetch_from_gdrive.py || true
          echo "== data/daily =="
          ls -al data/daily || true

      # 2) 소스별 주간 리포트 생성(슬랙 텍스트, 요약 JSON)
      - name: Generate weekly reports (all sources, sequential)
        env:
          DATA_DIR: ./data/daily
          MIN_DAYS: 3
        run: |
          for SRC in oy_kor oy_global amazon_us qoo10_jp daiso_kr; do
            echo ">>> generate $SRC"
            python scripts/weekly_report_plus.py \
              --src "$SRC" \
              --split \
              --data-dir "$DATA_DIR" \
              --min-days $MIN_DAYS || true
          done

      # 3) HTML 합본 생성
      - id: build_html
        run: |
          HTML_FILE=$(python scripts/build_html_report.py)
          echo "html=$HTML_FILE" >> "$GITHUB_OUTPUT"
          echo "built: $HTML_FILE"

      # 4) Google Drive 업서트
      - name: Upload HTML to Google Drive
        env:
          GOOGLE_CLIENT_ID:     ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID:     ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          python scripts/upload_to_gdrive.py "${{ steps.build_html.outputs.html }}"
